<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" type="image/png" href="/assets/design/favicon.png" />

  <title>Cinq erreurs classiques avec le chiffrement AES</title>
  <meta name="description" content="Écrit pour Swift 3 avec Xcode 8.1">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/dist/font-awesome-4.7.0/css/font-awesome.min.css">
  <link rel="canonical" href="https://blog.thomasdurand.fr/s%C3%A9curit%C3%A9/chiffrement/2017/07/12/bonnes-pratiques-de-chiffrement-aes-avec-swift.html">
  <link rel="alternate" type="application/rss+xml" title="Dean's blog" href="https://blog.thomasdurand.fr/feed.xml">

  
  
  <link rel="alternate" hreflang="en" href="/security/encryption/2017/07/12/aes-encryption-good-practice-with-swift.html" />
  
  <link rel="alternate" hreflang="fr" href="/s%C3%A9curit%C3%A9/chiffrement/2017/07/12/bonnes-pratiques-de-chiffrement-aes-avec-swift.html" />
  
  
  
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/articles.html">
      <img src="/assets/design/logo-fr@2x.png" height="40" alt="Le blog de Dean"/>
    </a>

    <div class="langs fr">
    
    
      <a href="/security/encryption/2017/07/12/aes-encryption-good-practice-with-swift.html" class="en">en</a>
    
      <a href="/s%C3%A9curit%C3%A9/chiffrement/2017/07/12/bonnes-pratiques-de-chiffrement-aes-avec-swift.html" class="fr">fr</a>
    

    
    
    </div>

    <nav class="site-nav">
      
      
        
        <a class="page-link" href="/articles.html">Articles</a>
        
      
        
        <a class="page-link" href="/a-propos/">À propos</a>
        
      
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Cinq erreurs classiques avec le chiffrement AES</h1>
    <p class="post-meta"><time datetime="2017-07-12T23:55:00+02:00" itemprop="datePublished">


    12
    
  	
	      juil.
	    
	2017

</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><strong>Écrit pour Swift 3 avec Xcode 8.1</strong></p>

<p>Avec des librairies comme <a href="https://github.com/krzyzanowskim/CryptoSwift">CryptoSwift</a>, il est devenu de plus en plus
aisé d’utiliser le chiffrement dans votre code. Cependant, il y a de nombreux pièges
dans lesquels il ne faut pas tomber lorsqu’on utilise la cryptographie !</p>

<p>La suite de cet article utilisera CryptoSwift pour ses exemples.</p>

<h3 id="1-ne-pas-hard-coder-les-clés-dans-le-code">1. Ne pas “Hard Coder” les clés dans le code</h3>

<p>Tout ce que vous placez dans le code est, d’une façon ou d’une autre, lisible par n’importe qui.
C’est toujours possible pour un attaquant de retrouver quelque chose, même caché dans le code
compilé de votre application.</p>

<p>De plus, “hard coder” une clé signifie que la clé est la même pour tous les utilisateurs,
ce qui permettrait à un attaquant de déchiffrer les données de n’importe qui après avoir
analysé le code de l’application.</p>

<p>Le dernier point, c’est l’importance de l’aléatoire dans une clé :
Une clé doit être entropique, elle doit pouvoir être n’importe quoi.
Le prochain octet doit pouvoir correspondre à n’importe quoi, ce qui n’est pas
vraiment le cas d’une chaîne de caractère UTF8, par exemple.</p>

<p>La solution ?<br />
Il faut <strong>générer</strong> une clé lorsque vous en avez besoin d’une nouvelle, et la stocker dans un endroit sécurisé.</p>

<p>On peut générer une clé pour  :</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">func</span> <span class="nf">generateRandomData</span><span class="p">(</span><span class="nv">size</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Data</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">data</span> <span class="o">=</span> <span class="kt">Data</span><span class="p">(</span><span class="nv">count</span><span class="p">:</span> <span class="n">size</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">withUnsafeMutableBytes</span> <span class="p">{</span>
        <span class="p">(</span><span class="nv">mutableBytes</span><span class="p">:</span> <span class="kt">UnsafeMutablePointer</span><span class="o">&lt;</span><span class="kt">UInt8</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Int32</span> <span class="k">in</span>
        <span class="kt">SecRandomCopyBytes</span><span class="p">(</span><span class="n">kSecRandomDefault</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="n">mutableBytes</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="n">errSecSuccess</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="kt">Errors</span><span class="o">.</span><span class="n">unableToGenerateData</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">data</span>
<span class="p">}</span>

<span class="c1">// La taille de la clé pour l'AES 256 est 256 ÷ 8 = 32</span>
<span class="k">let</span> <span class="nv">myAES256keyData</span> <span class="o">=</span> <span class="k">try</span> <span class="nf">generateRandomData</span><span class="p">(</span><span class="nv">size</span><span class="p">:</span> <span class="mi">32</span><span class="p">)</span>

<span class="c1">// Stockez la clé dans un endroit sûr</span></code></pre></figure>

<h3 id="2-stockez-vos-clés-dans-le-keychain">2. Stockez vos clés dans le Keychain</h3>

<p>Autant mettre les choses aux clair tout de suite, il n’y a <strong>pas de meilleur endroit</strong> pour stocker
une donnée sensible comme une clé ou un mot de passe que le <a href="https://developer.apple.com/documentation/security/keychain_services">Keychain</a>.</p>

<p>Il s’agit d’un logiciel d’Apple designé pour stocker de façon très sécurisée
les mots de passe, certificats, et clés de chiffrement.
Le Keychain est maintenu par Apple avec des mises à jour régulières des logiciels,
et finalement, il tire parti des composants matériels comme <a href="https://www.quora.com/What-is-Apple’s-new-Secure-Enclave-and-why-is-it-important">l’enclave sécurisée</a> 
pour assurer les meilleurs niveaux de sécurité.</p>

<p>TL;DR: Utilisez le Keychain, C’est l’alternative la plus sécurisée que vous avez !</p>

<p>Il est très aisé de stocker et d’accéder au Keychain lorsqu’on utilise un wrapper comme <a href="https://github.com/evgenyneu/keychain-swift">Keychain-Swift</a>:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">import</span> <span class="kt">KeychainSwift</span>

<span class="k">let</span> <span class="nv">keychain</span> <span class="o">=</span> <span class="kt">KeychainSwift</span><span class="p">()</span>

<span class="c1">// Stockons la clé créée précédemment</span>
<span class="n">keychain</span><span class="o">.</span><span class="nf">set</span><span class="p">(</span><span class="n">dataObject</span><span class="p">,</span> <span class="nv">forKey</span><span class="p">:</span> <span class="s">"my key"</span><span class="p">,</span> <span class="nv">withAccess</span><span class="p">:</span> <span class="o">.</span><span class="n">accessibleWhenUnlockedThisDeviceOnly</span><span class="p">)</span>

<span class="c1">// Récupérons la clé quand on en a besoin</span>
<span class="k">let</span> <span class="nv">key</span> <span class="o">=</span> <span class="n">keychain</span><span class="o">.</span><span class="nf">getData</span><span class="p">(</span><span class="s">"my key"</span><span class="p">)</span></code></pre></figure>

<h3 id="3-paramétrer-correctement-laccès-au-keychain">3. Paramétrer correctement l’accès au Keychain</h3>

<p>Vous n’avez peut-être pas encore remarqué, mais j’ai utilisé un paramètre d’accès dans
le setter dans le point précédent.</p>

<p><code class="highlighter-rouge">accessibleWhenUnlockedThisDeviceOnly</code> (<a href="https://developer.apple.com/documentation/security/ksecattraccessiblewhenunlockedthisdeviceonly">ref</a>) est le minimum acceptable que 
j’utilise dans mon exemple précédent.<br />
Il vaut mieux utiliser <code class="highlighter-rouge">accessibleWhenPasscodeSetThisDeviceOnly</code> 
(<a href="https://developer.apple.com/documentation/security/ksecattraccessiblewhenpasscodesetthisdeviceonly">ref</a>) lorsqu’il est disponible.</p>

<p>That is needed to provide a correct level of security for your stored key.
It make sure the device is unlocked, prevent backups and keychain sharing between
devices, and it can also make sure the device is secured by an unlock code.</p>

<h3 id="4-utilisez-un-vecteur-dinitialisation">4. Utilisez un vecteur d’initialisation</h3>

<p>Chiffrer les données est de bonne pratique pour éviter quiconque de lire les données sensibles.</p>

<p>Mais que ce passe-t-il si un attaquant peut lire les données sans posséder la clé,
simplement en analysant les données chiffrées ?</p>

<p>C’est ce qui rend le vecteur d’initialisation si important !</p>

<p>Prenons un exemple où nous avons besoin de chiffrer un booléen, car on ne souhaite 
pas qu’un attaquant puisse avoir qui possède une fonctionnalité ou non.</p>

<p>Consultons les données après le chiffrement :</p>

<table>
  <thead>
    <tr>
      <th>valeur</th>
      <th>pas d’IV (ou partagé)</th>
      <th>IV aléatoire</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">false</code></td>
      <td><code class="highlighter-rouge">HspSmVFeseu7kpt5ZJE13A==</code></td>
      <td><code class="highlighter-rouge">6sM2RzgShVcu1OPM8sH0mw==</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">false</code></td>
      <td><code class="highlighter-rouge">HspSmVFeseu7kpt5ZJE13A==</code></td>
      <td><code class="highlighter-rouge">ylJjMWFq4MoqKvpn5WSYOQ==</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">true</code></td>
      <td><code class="highlighter-rouge">sdkaq/5TFZKjFjx35Cl0rw==</code></td>
      <td><code class="highlighter-rouge">JZHeEoBfgQgk8/8eOQlQxQ==</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">true</code></td>
      <td><code class="highlighter-rouge">sdkaq/5TFZKjFjx35Cl0rw==</code></td>
      <td><code class="highlighter-rouge">byfgDi+CD7pAo2NXYk8tVw==</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">false</code></td>
      <td><code class="highlighter-rouge">HspSmVFeseu7kpt5ZJE13A==</code></td>
      <td><code class="highlighter-rouge">XxWfqQXe3EwNuJ3AzvgOig==</code></td>
    </tr>
  </tbody>
</table>

<p>Une idée de ce qui ne va pas ?
Toutes les données identiques, chiffrées avec la même clé et le même vecteur d’initialisation
auront le même résultat.</p>

<p>La conséquence est très mauvaise pour vos données, car l’attaquant pourrait éventuellement
accéder aux données chiffrées (et croyez moi, ça n’a rien de sorcier sur une application iOS),
puis réaliser des analyses sur les donénes pour en déduire la valeur initiale.</p>

<p>Pour éviter cela, il est primordial de générer un vecteur d’initialisation unique et aléatoire
à chaque opération de chiffrement que vous pourriez réaliser.</p>

<p>Bien évidemment, ce vecteur est indispensable pour le déchiffrement de la donnée, au même
titre que la clé.
Un endroit opportunt pour stocker le vecteur d’initialisation, c’est avec la donnée chiffrée, 
exactement comme on le ferait pour le <a href="https://fr.wikipedia.org/wiki/Salage_(cryptographie)">sel d’un hashage de mot de passe</a>.</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="c1">// On génère un vecteur d'initialisation à usage unique :</span>
<span class="k">let</span> <span class="nv">iv</span> <span class="o">=</span> <span class="kt">AES</span><span class="o">.</span><span class="nf">randomIV</span><span class="p">(</span><span class="kt">AES</span><span class="o">.</span><span class="n">blockSize</span><span class="p">)</span>

<span class="c1">// On chiffre les données :</span>
<span class="k">let</span> <span class="nv">crypted</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">AES</span><span class="p">(</span><span class="nv">key</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="nv">iv</span><span class="p">:</span> <span class="n">iv</span><span class="p">)</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1">// Puis on stocke les données chiffrées avec son vecteur associé</span>
<span class="n">myStorage</span><span class="o">.</span><span class="n">securedData</span> <span class="o">=</span> <span class="p">(</span><span class="n">crypted</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span></code></pre></figure>

<h3 id="5-nutilisez-pas-le-mode-de-traitement-de-bloc-ecb">5. N’utilisez pas le mode de traitement de bloc ECB</h3>

<p>Le mode de traitement de bloc que vous choisissez dans votre algorithme de chiffrement
correspond à la méthode utilisée par l’algorithme pour effectuer le chiffrement</p>

<p>Le choix d’un bon mode de traitement est donc essentiel pour rendre votre chiffrement utile et sécurisé.</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="c1">// Quelques méthodes disponibles</span>
<span class="k">let</span> <span class="nv">encryptedWithCBC</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">AES</span><span class="p">(</span><span class="nv">key</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="nv">iv</span><span class="p">:</span> <span class="n">iv</span><span class="p">,</span> <span class="nv">blockMode</span><span class="p">:</span> <span class="o">.</span><span class="kt">CBC</span><span class="p">,</span> <span class="nv">padding</span><span class="p">:</span> <span class="kt">PKCS7</span><span class="p">())</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">encryptedWithCTR</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">AES</span><span class="p">(</span><span class="nv">key</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="nv">iv</span><span class="p">:</span> <span class="n">iv</span><span class="p">,</span> <span class="nv">blockMode</span><span class="p">:</span> <span class="o">.</span><span class="kt">CTR</span><span class="p">,</span> <span class="nv">padding</span><span class="p">:</span> <span class="kt">PKCS7</span><span class="p">())</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>

<span class="c1">// Et celle que vous ne devriez jamais utiliser...</span>
<span class="k">let</span> <span class="nv">encryptedWithECB</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">AES</span><span class="p">(</span><span class="nv">key</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="nv">iv</span><span class="p">:</span> <span class="n">iv</span><span class="p">,</span> <span class="nv">blockMode</span><span class="p">:</span> <span class="o">.</span><span class="kt">ECB</span><span class="p">,</span> <span class="nv">padding</span><span class="p">:</span> <span class="kt">PKCS7</span><span class="p">())</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="n">input</span><span class="p">)</span></code></pre></figure>

<p>Mais pourquoi l’ECB est-il un mauvais choix ?</p>

<p>ECB (Electronic Code Book) chiffre chaque bloc de données de votre entrée de façon séparée.
Le danger se situe dans le fait que cette méthode chiffrera de la même manière tout bloc similaire,
et tout comme le manque de vecteur d’initialisation, cela rend le chiffrement prévisible.</p>

<p>Cela peut aussi causer des attaques par répétition, et à la fuite d’informations.</p>

<p>Pour vous prouver que l’ECB n’est pas une méthode chiffrement sécurisée, rien ne
vaut cet exemple de <a href="https://fr.wikipedia.org/wiki/Mode_d%27opération_(cryptographie)">Wikipedia</a> utilisant une image comme données à chiffrer :</p>

<p><img src="/assets/ios/crypto-practices/ECB-fr.png" alt="Illustration du manque de sécurité liée à l'utilisation de ECB pour le chiffrement d'une image" /></p>

<p>Il est donc clair qu’avec ce mode d’opération, le contenu de l’image n’est pas devenu
totalement illisible. Il y a un manque d’imprédicitiblité lié à la conception même de ce
mode de fonctionnement. C’est aussi pourquoi ce mode ne devrait <strong>jamais</strong> être utilisé
à des fin cryptographiques.</p>

<p>Pour éviter cela, il faut utiliser CBC (Cipher Block Chaining) qui utilise le bloc précédent 
pour chiffrer le suivant, ce qui rend le résultat beaucoup plus aléatoire et imprédictible.</p>

<h3 id="conclusion">Conclusion</h3>

<p>Bien qu’il soit aisé d’utiliser le chiffrement aujourd’hui, en tant que développeur,
il est aussi très facile de faire des erreurs lorsqu’on utilise AES, ce qui rend le
procédé insécure, voire même parfois, inutile.</p>

<p>La principale raison, c’est que lorsqu’on à affaire à du chiffrement, il est important de
comprendre ce qu’il se passe, et les objets que l’on utilise, et aussi connaitre les
erreurs classiques à éviter.</p>

<p>J’espère que vos fonctionnalités de chiffrement seront sécurisées un brin plus après la lecture de cet article !</p>


  </div>

  <div class="share-page">
    <h3>Partager sur :</h3>
    <ul>
    <li class="share-button share-twitter">
    	<a href="https://twitter.com/intent/tweet?text=Cinq erreurs classiques avec le chiffrement AES&url=https://blog.thomasdurand.fr/s%C3%A9curit%C3%A9/chiffrement/2017/07/12/bonnes-pratiques-de-chiffrement-aes-avec-swift.html&via=deanatoire&related=deanatoire" rel="nofollow" target="_blank" title="Share on Twitter">
    	<span class="fa fa-twitter"></span> <span class="title">Twitter</span></a>
    </li>
    <li class="share-button share-facebook">
    	<a href="https://facebook.com/sharer.php?u=https://blog.thomasdurand.fr/s%C3%A9curit%C3%A9/chiffrement/2017/07/12/bonnes-pratiques-de-chiffrement-aes-avec-swift.html" rel="nofollow" target="_blank" title="Share on Facebook">
    	<span class="fa fa-facebook-official"></span> <span class="title">Facebook</span></a>
    </li>
    <li class="share-button share-linkedin">
    	<a href="http://www.linkedin.com/shareArticle?mini=true&url=https://blog.thomasdurand.fr/s%C3%A9curit%C3%A9/chiffrement/2017/07/12/bonnes-pratiques-de-chiffrement-aes-avec-swift.html&title=Cinq erreurs classiques avec le chiffrement AES&summary=Le blog de Dean est un blog d'informatique et de développement&source=https://blog.thomasdurand.fr" rel="nofollow" target="_blank" title="Share on LinkedIn">
    	<span class="fa fa-linkedin-square"></span> <span class="title">LinkedIn</span></a>
    </li>
    </ul>
</div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Le blog de Dean</li>
          <li><a href="mailto:contact@thomasdurand.fr">contact@thomasdurand.fr</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3"></div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/dean151"><span class="fa fa-github"></span> <span class="username">dean151</span></a>
          </li>
          

          
          <li>
            <a href="https://linkedin.com/in/thomasdurandverjat"><span class="fa fa-linkedin"></span> <span class="username">thomasdurandverjat</span></a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/deanatoire"><span class="fa fa-twitter"></span> <span class="username">deanatoire</span></a>
          </li>
          

          <li>
            <a href="/feed.xml"><span class="fa fa-rss"></span> <span class="username">flux rss</span></a>
          </li>
        </ul>
      </div>
    </div>

  </div>

</footer>


    <script type="text/javascript">
      var _paq = _paq || [];
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        _paq.push(['setTrackerUrl', '/p/']);
        _paq.push(['setSiteId', '14']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.type='text/javascript'; g.async=true; g.defer=true; g.src='/p/'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <noscript><p><img src="/p/?idsite=14&rec=1" style="border:0;" alt="" /></p></noscript>
  </body>

</html>
